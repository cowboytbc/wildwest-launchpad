<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet Connection Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #111; color: white; }
        .test-section { border: 1px solid #333; padding: 15px; margin: 10px 0; background: #222; }
        .status { padding: 5px; margin: 5px 0; border-radius: 3px; }
        .success { background: #1a5f1a; border: 1px solid #2d8f2d; }
        .error { background: #5f1a1a; border: 1px solid #8f2d2d; }
        .warning { background: #5f5f1a; border: 1px solid #8f8f2d; }
        button { padding: 10px 20px; margin: 5px; background: #444; border: 1px solid #666; color: white; cursor: pointer; }
        button:hover { background: #555; }
        .log { background: #000; padding: 10px; margin: 10px 0; border: 1px solid #333; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>üîß Wallet Connection Diagnostic Test</h1>
    
    <div class="test-section">
        <h3>üîó Connection Status</h3>
        <div id="connectionStatus" class="status">Not connected</div>
        <button onclick="testWalletConnection()">Test Wallet Connection</button>
        <button onclick="testDirectBase()">Test Direct Base Connection</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>
    
    <div class="test-section">
        <h3>üìä Wallet Variables</h3>
        <div id="walletVariables"></div>
    </div>
    
    <div class="test-section">
        <h3>üåê Network Status</h3>
        <div id="networkStatus"></div>
    </div>
    
    <div class="test-section">
        <h3>üìù Debug Log</h3>
        <div id="debugLog" class="log"></div>
    </div>

    <script>
        let logContainer = document.getElementById('debugLog');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.style.color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : type === 'warning' ? '#ffd43b' : '#c9c9c9';
            entry.innerHTML = `[${timestamp}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearLogs() {
            logContainer.innerHTML = '';
        }
        
        function updateStatus(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = content;
            element.className = 'status ' + type;
        }
        
        function updateWalletVariables() {
            const vars = {
                'window.ethereum': !!window.ethereum,
                'window.wildWestWallet': !!window.wildWestWallet,
                'wildWestWallet.account': window.wildWestWallet?.account || 'undefined',
                'wildWestWallet.provider': !!window.wildWestWallet?.provider,
                'wildWestWallet.signer': !!window.wildWestWallet?.signer,
                'Current Chain ID': window.ethereum?.chainId || 'unknown'
            };
            
            let html = '';
            for (const [key, value] of Object.entries(vars)) {
                const isGood = (key.includes('ethereum') || key.includes('wildWestWallet')) ? value : 
                              key === 'wildWestWallet.account' ? value !== 'undefined' :
                              key === 'Current Chain ID' ? value === '0x2105' || value === 8453 : value;
                html += `<div class="status ${isGood ? 'success' : 'error'}">${key}: ${value}</div>`;
            }
            document.getElementById('walletVariables').innerHTML = html;
        }
        
        async function testWalletConnection() {
            log('üîÑ Starting wallet connection test...', 'info');
            
            try {
                // Test 1: Check if MetaMask is available
                if (!window.ethereum) {
                    log('‚ùå MetaMask not detected', 'error');
                    updateStatus('connectionStatus', 'MetaMask not found', 'error');
                    return;
                }
                log('‚úÖ MetaMask detected', 'success');
                
                // Test 2: Request account access
                log('üîë Requesting account access...', 'info');
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                log(`‚úÖ Accounts received: ${accounts.length} account(s)`, 'success');
                log(`üìç Primary account: ${accounts[0]}`, 'info');
                
                // Test 3: Check current chain
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                log(`üåê Current chain ID: ${chainId} (${parseInt(chainId, 16)})`, 'info');
                
                // Test 4: Try to switch to Base if not already
                if (chainId !== '0x2105') {
                    log('üîÑ Switching to Base network...', 'warning');
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x2105' }],
                        });
                        log('‚úÖ Successfully switched to Base', 'success');
                    } catch (switchError) {
                        log(`‚ö†Ô∏è Could not switch to Base: ${switchError.message}`, 'warning');
                    }
                } else {
                    log('‚úÖ Already on Base network', 'success');
                }
                
                // Test 5: Test wildWestWallet object
                if (window.wildWestWallet) {
                    log('‚úÖ wildWestWallet object exists', 'success');
                    window.wildWestWallet.account = accounts[0];
                    log(`‚úÖ Set wildWestWallet.account = ${accounts[0]}`, 'success');
                    
                    // Try to create provider and signer
                    if (window.ethers) {
                        log('‚úÖ ethers.js detected', 'success');
                        try {
                            window.wildWestWallet.provider = new ethers.providers.Web3Provider(window.ethereum);
                            window.wildWestWallet.signer = window.wildWestWallet.provider.getSigner();
                            log('‚úÖ Created provider and signer', 'success');
                        } catch (ethersError) {
                            log(`‚ùå Error creating provider/signer: ${ethersError.message}`, 'error');
                        }
                    } else {
                        log('‚ùå ethers.js not detected', 'error');
                    }
                } else {
                    log('‚ùå wildWestWallet object not found', 'error');
                }
                
                updateStatus('connectionStatus', `Connected: ${accounts[0].substring(0, 8)}...`, 'success');
                
            } catch (error) {
                log(`‚ùå Connection failed: ${error.message}`, 'error');
                updateStatus('connectionStatus', `Failed: ${error.message}`, 'error');
            }
            
            updateWalletVariables();
        }
        
        async function testDirectBase() {
            log('üîÑ Testing direct Base network connection...', 'info');
            
            try {
                if (!window.ethereum) {
                    log('‚ùå MetaMask not available', 'error');
                    return;
                }
                
                // Force switch to Base
                log('üîÑ Forcing switch to Base (0x2105)...', 'info');
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x2105' }],
                });
                
                // Get accounts
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                log(`‚úÖ Base connection successful: ${accounts[0]}`, 'success');
                
                // Verify chain
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                log(`‚úÖ Chain ID confirmed: ${chainId} (${parseInt(chainId, 16)})`, 'success');
                
                updateStatus('connectionStatus', `Base Connected: ${accounts[0].substring(0, 8)}...`, 'success');
                
            } catch (error) {
                log(`‚ùå Base connection failed: ${error.message}`, 'error');
                updateStatus('connectionStatus', `Base Failed: ${error.message}`, 'error');
            }
            
            updateWalletVariables();
        }
        
        // Initial status check
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Wallet diagnostic tool loaded', 'info');
            updateWalletVariables();
            
            // Check network status
            if (window.ethereum) {
                window.ethereum.request({ method: 'eth_chainId' }).then(chainId => {
                    const networkName = chainId === '0x2105' ? 'Base Mainnet' : 
                                      chainId === '0x1' ? 'Ethereum Mainnet' :
                                      chainId === '0x89' ? 'Polygon' : `Unknown (${chainId})`;
                    updateStatus('networkStatus', `Current Network: ${networkName}`, chainId === '0x2105' ? 'success' : 'warning');
                });
            } else {
                updateStatus('networkStatus', 'MetaMask not detected', 'error');
            }
        });
        
        // Auto-update wallet variables every 2 seconds
        setInterval(updateWalletVariables, 2000);
    </script>
</body>
</html>
