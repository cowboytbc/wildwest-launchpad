name: Deploy to GitHub Pages with QuickNode Secrets

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        
    - name: Setup Pages
      uses: actions/configure-pages@v3
      
    - name: Inject production secrets
      env:
        PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        SOLANA_RPC_ENDPOINT: ${{ secrets.SOLANA_RPC_ENDPOINT }}
        BASE_RPC_ENDPOINT: ${{ secrets.BASE_RPC_ENDPOINT }}
        WTFDUDE: ${{ secrets.WTFDUDE }}
      run: |
        echo "ðŸ”§ Checking GitHub Secrets availability..."
        
        # Debug secret availability (without exposing values)
        echo "PERSONAL_ACCESS_TOKEN: $([ -n "$PERSONAL_ACCESS_TOKEN" ] && echo "âœ… SET" || echo "âŒ MISSING")"
        echo "SOLANA_RPC_ENDPOINT: $([ -n "$SOLANA_RPC_ENDPOINT" ] && echo "âœ… SET" || echo "âŒ MISSING")"
        echo "BASE_RPC_ENDPOINT: $([ -n "$BASE_RPC_ENDPOINT" ] && echo "âœ… SET" || echo "âŒ MISSING")"
        echo "WTFDUDE: $([ -n "$WTFDUDE" ] && echo "âœ… SET" || echo "âŒ MISSING")"
        
        # Create production config with QuickNode endpoints
        echo "âœ… Creating production config with QuickNode endpoints..."
        cat > js/production-config.js << 'EOF'
        // Production QuickNode endpoints injected from GitHub Secrets
        (function() {
          'use strict';
          console.log('ðŸ” Loading QuickNode endpoints from GitHub Secrets...');
          window.PRODUCTION_CONFIG = {
            token: 'PLACEHOLDER_TOKEN',
            rpc: {
              solana: 'PLACEHOLDER_SOLANA',
              base: 'PLACEHOLDER_BASE'
            },
            injectedAt: new Date().toISOString(),
            source: 'github-secrets-quicknode'
          };
          console.log('âœ… QuickNode endpoints loaded successfully!');
          console.log('ðŸŸ£ Solana RPC ready');
          console.log('ðŸ”µ Base RPC ready');
        })();
        EOF
        
        # Replace placeholders with actual values
        sed -i "s|PLACEHOLDER_TOKEN|${WTFDUDE}|g" js/production-config.js
        sed -i "s|PLACEHOLDER_SOLANA|${SOLANA_RPC_ENDPOINT}|g" js/production-config.js
        sed -i "s|PLACEHOLDER_BASE|${BASE_RPC_ENDPOINT}|g" js/production-config.js
        
        echo "âœ… QuickNode endpoints injected!"
        echo "--- Production config preview ---"
        head -10 js/production-config.js
        echo "--- End preview ---"
        
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v2
      with:
        path: '.'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2
